#!/usr/bin/env node
/**
 * é›†ç´„ä¿å­˜æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 * ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã‚’ä½¿ç”¨ã—ã¦é›†ç´„ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿æ›¸ãã‚’ãƒ†ã‚¹ãƒˆ
 */

const { spawn } = require('child_process');
const path = require('path');
const os = require('os');

// ãƒ†ã‚¹ãƒˆç”¨ã®è¨˜äº‹ãƒ‡ãƒ¼ã‚¿
const testArticleData = {
    title: 'ãƒ†ã‚¹ãƒˆè¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«',
    url: 'https://example.com/test-article',
    content: 'ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆè¨˜äº‹ã®å†…å®¹ã§ã™ã€‚é›†ç´„ä¿å­˜æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚',
    summary: 'ãƒ†ã‚¹ãƒˆè¨˜äº‹ã®è¦ç´„ã§ã™ã€‚é›†ç´„ä¿å­˜æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚',
    savedDate: new Date(),
    shortSummary: 'é›†ç´„ä¿å­˜ãƒ†ã‚¹ãƒˆè¨˜äº‹'
};

const testSettings = {
    obsidianPath: path.join(os.homedir(), 'Documents', 'Obsidian', 'ReadLater'),
    aggregatedSavingEnabled: true,
    aggregatedFileName: 'ReadLater_Articles.md',
    summaryEnabled: true
};

/**
 * ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
 */
function sendNativeMessage(message) {
    return new Promise((resolve, reject) => {
        const nativeHostPath = path.join(__dirname, '..', '..', 'native_host', 'claude_host.js');
        const child = spawn('node', [nativeHostPath], {
            stdio: ['pipe', 'pipe', 'pipe']
        });

        let stdout = '';
        let stderr = '';

        child.stdout.on('data', (data) => {
            stdout += data.toString();
        });

        child.stderr.on('data', (data) => {
            stderr += data.toString();
        });

        child.on('close', (code) => {
            if (code === 0) {
                try {
                    // 4ãƒã‚¤ãƒˆã®é•·ã•ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦JSONã‚’è§£æ
                    const jsonData = stdout.slice(4);
                    const result = JSON.parse(jsonData);
                    resolve(result);
                } catch (e) {
                    reject(new Error(`JSONè§£æã‚¨ãƒ©ãƒ¼: ${e.message}\nå‡ºåŠ›: ${stdout}`));
                }
            } else {
                reject(new Error(`ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ›ã‚¹ãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸ (ã‚³ãƒ¼ãƒ‰: ${code})\nã‚¨ãƒ©ãƒ¼: ${stderr}`));
            }
        });

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
        const jsonMessage = JSON.stringify(message);
        const buffer = Buffer.from(jsonMessage, 'utf8');
        const lengthBuffer = Buffer.alloc(4);
        lengthBuffer.writeUInt32LE(buffer.length, 0);
        
        child.stdin.write(lengthBuffer);
        child.stdin.write(buffer);
        child.stdin.end();
    });
}

/**
 * é›†ç´„ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›¸ãè¾¼ã¿ãƒ†ã‚¹ãƒˆ
 */
async function testWriteFile() {
    console.log('ğŸ“ é›†ç´„ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿ãƒ†ã‚¹ãƒˆé–‹å§‹...');
    
    try {
        const filePath = path.join(testSettings.obsidianPath, testSettings.aggregatedFileName);
        const content = `# ReadLater Articles

| ã‚¿ã‚¤ãƒˆãƒ« | URL | è¦ç´„ | æ—¥æ™‚ |
|---------|-----|------|------|
| ${testArticleData.title} | ${testArticleData.url} | ${testArticleData.shortSummary} | ${testArticleData.savedDate.toISOString().split('T')[0]} |

## è¨˜äº‹è©³ç´°

### ${testArticleData.title}

**å…ƒè¨˜äº‹**: [${testArticleData.title}](${testArticleData.url})
**ä¿å­˜æ—¥**: ${testArticleData.savedDate.toISOString().split('T')[0]}

## è¦ç´„

${testArticleData.summary}

## å†…å®¹

${testArticleData.content}

---
*Generated by ReadLater for Obsidian*
`;

        const result = await sendNativeMessage({
            type: 'writeFile',
            filePath: filePath,
            content: content
        });

        if (result.ok) {
            console.log('âœ… ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿æˆåŠŸ:', result.filePath);
            console.log(`   ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${result.bytes} bytes`);
            return result.filePath;
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿å¤±æ•—:', error.message);
        throw error;
    }
}

/**
 * é›†ç´„ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
 */
async function testReadFile(filePath) {
    console.log('ğŸ“– é›†ç´„ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆé–‹å§‹...');
    
    try {
        const result = await sendNativeMessage({
            type: 'readFile',
            filePath: filePath
        });

        if (result.ok) {
            console.log('âœ… ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ:', result.filePath);
            console.log(`   ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${result.bytes} bytes`);
            console.log('   å†…å®¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:', result.content.substring(0, 200) + '...');
            return result.content;
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—:', error.message);
        throw error;
    }
}

/**
 * é›†ç´„ãƒ•ã‚¡ã‚¤ãƒ«ã®è¿½åŠ ãƒ†ã‚¹ãƒˆ
 */
async function testAppendToFile(filePath) {
    console.log('â• é›†ç´„ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ ãƒ†ã‚¹ãƒˆé–‹å§‹...');
    
    try {
        // æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
        const existingContent = await testReadFile(filePath);
        
        // æ–°ã—ã„è¨˜äº‹ã‚’è¿½åŠ 
        const newArticle = {
            ...testArticleData,
            title: 'è¿½åŠ ãƒ†ã‚¹ãƒˆè¨˜äº‹',
            url: 'https://example.com/added-article',
            content: 'ã“ã‚Œã¯è¿½åŠ ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆè¨˜äº‹ã§ã™ã€‚',
            summary: 'è¿½åŠ è¨˜äº‹ã®è¦ç´„ã§ã™ã€‚',
            savedDate: new Date()
        };
        
        const newTableRow = `| ${newArticle.title} | ${newArticle.url} | ${newArticle.shortSummary} | ${newArticle.savedDate.toISOString().split('T')[0]} |`;
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ–°ã—ã„è¡Œã‚’è¿½åŠ 
        const updatedContent = existingContent.replace(
            /(\| ã‚¿ã‚¤ãƒˆãƒ« \|[\s\S]*?)(\n## è¨˜äº‹è©³ç´°)/,
            `$1\n${newTableRow}$2`
        );
        
        // è¨˜äº‹è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ 
        const newArticleDetail = `

### ${newArticle.title}

**å…ƒè¨˜äº‹**: [${newArticle.title}](${newArticle.url})
**ä¿å­˜æ—¥**: ${newArticle.savedDate.toISOString().split('T')[0]}

## è¦ç´„

${newArticle.summary}

## å†…å®¹

${newArticle.content}
`;
        
        const finalContent = updatedContent.replace(
            /(## è¨˜äº‹è©³ç´°[\s\S]*?)(\n---\n.*Generated by ReadLater|$)/,
            `$1${newArticleDetail}\n$2`
        );
        
        // æ›´æ–°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
        const result = await sendNativeMessage({
            type: 'writeFile',
            filePath: filePath,
            content: finalContent
        });

        if (result.ok) {
            console.log('âœ… ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ æˆåŠŸ:', result.filePath);
            console.log(`   ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${result.bytes} bytes`);
            return result.filePath;
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ å¤±æ•—:', error.message);
        throw error;
    }
}

/**
 * ãƒ¡ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
 */
async function runTests() {
    console.log('ğŸš€ é›†ç´„ä¿å­˜æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆé–‹å§‹');
    console.log('================================');
    
    try {
        // 1. ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿ãƒ†ã‚¹ãƒˆ
        const filePath = await testWriteFile();
        console.log('');
        
        // 2. ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
        await testReadFile(filePath);
        console.log('');
        
        // 3. ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ ãƒ†ã‚¹ãƒˆ
        await testAppendToFile(filePath);
        console.log('');
        
        console.log('ğŸ‰ ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼');
        console.log('é›†ç´„ä¿å­˜æ©Ÿèƒ½ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚');
        
    } catch (error) {
        console.error('ğŸ’¥ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ:', error.message);
        process.exit(1);
    }
}

// ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
if (require.main === module) {
    runTests();
}

module.exports = {
    testWriteFile,
    testReadFile,
    testAppendToFile,
    runTests
};
