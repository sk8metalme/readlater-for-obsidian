// ReadLater for Obsidian - Aggregated Markdown Generator
// é›†ç´„Markdownãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã®ç”Ÿæˆã‚’æ‹…å½“ã™ã‚‹ã‚¯ãƒ©ã‚¹

// Note: MarkdownGeneratorã¨ArticleTableManagerã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã‹ã‚‰å–å¾—
// require()ã‚’ä½¿ç”¨ã™ã‚‹ã¨importScripts()ã¨ã®ç«¶åˆãŒç™ºç”Ÿã™ã‚‹ãŸã‚å‰Šé™¤

/**
 * é›†ç´„Markdownãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆã‚¯ãƒ©ã‚¹
 */
class AggregatedMarkdownGenerator {
    constructor(dependencies = {}) {
        // ä¾å­˜é–¢ä¿‚ã®æ³¨å…¥ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã‹ã‚‰ã‚¯ãƒ©ã‚¹ã‚’å–å¾—ï¼ˆimportScriptsã¾ãŸã¯ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ï¼‰
        const MarkdownGeneratorClass = dependencies.markdownGenerator ? dependencies.markdownGenerator.constructor : 
            (typeof MarkdownGenerator !== 'undefined' ? MarkdownGenerator : null);
        const ArticleTableManagerClass = dependencies.tableManager ? dependencies.tableManager.constructor :
            (typeof ArticleTableManager !== 'undefined' ? ArticleTableManager : null);
        
        this.markdownGenerator = dependencies.markdownGenerator || 
            (MarkdownGeneratorClass ? new MarkdownGeneratorClass() : null);
        this.tableManager = dependencies.tableManager || 
            (ArticleTableManagerClass ? new ArticleTableManagerClass() : null);
        
        this.options = {
            includeTableOfContents: true,
            includeSummaryStats: true,
            defaultTitle: 'ReadLater Articles',
            ...dependencies.options
        };
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®åˆæœŸåŒ–
        const ErrorHandlerClass = typeof ErrorHandler !== 'undefined' ? ErrorHandler : null;
        this.errorHandler = dependencies.errorHandler || 
            (ErrorHandlerClass ? new ErrorHandlerClass() : {
                handleError: (e) => ({ error: e?.message }),
                retry: async (fn) => fn()
            });
    }

    /**
     * è¤‡æ•°è¨˜äº‹ã‹ã‚‰é›†ç´„Markdownã‚’ç”Ÿæˆ
     * @param {Array<Object>} articles - è¨˜äº‹é…åˆ—
     * @param {Object} settings - ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
     * @returns {Promise<string>} é›†ç´„Markdownã‚³ãƒ³ãƒ†ãƒ³ãƒ„
     */
    async generateAggregatedMarkdown(articles, settings) {
        try {
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!Array.isArray(articles)) {
                throw new Error('è¨˜äº‹é…åˆ—ãŒç„¡åŠ¹ã§ã™');
            }
            
            if (articles.length === 0) {
                console.warn('AggregatedMarkdownGenerator: Empty articles array provided');
            }
            
            if (!settings) {
                throw new Error('è¨­å®šãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ã§ã™');
            }

            const sections = [];

            // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼
            try {
                sections.push(this.generateFileHeader(settings));
            } catch (error) {
                console.warn('AggregatedMarkdownGenerator: Header generation failed, using fallback');
                sections.push(`# ${this.options.defaultTitle}\n`);
            }

            // ç›®æ¬¡ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            if (this.options.includeTableOfContents) {
                try {
                    sections.push(this.generateTableOfContents(articles));
                } catch (error) {
                    console.warn('AggregatedMarkdownGenerator: TOC generation failed, skipping');
                }
            }

            // è¨˜äº‹ä¸€è¦§è¡¨
            try {
                sections.push(this.generateArticleTable(articles, settings));
            } catch (error) {
                console.warn('AggregatedMarkdownGenerator: Table generation failed, using fallback');
                sections.push('## è¨˜äº‹ä¸€è¦§\n\nè¨˜äº‹ä¸€è¦§ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n');
            }

            // è¨˜äº‹è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            try {
                sections.push(this.generateArticleDetailsSection(articles));
            } catch (error) {
                console.warn('AggregatedMarkdownGenerator: Article details generation failed, using fallback');
                sections.push('## ğŸ“– è¨˜äº‹è©³ç´°\n\nè¨˜äº‹è©³ç´°ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n');
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ãƒƒã‚¿ãƒ¼
            try {
                sections.push(this.generateFileFooter(articles.length));
            } catch (error) {
                console.warn('AggregatedMarkdownGenerator: Footer generation failed, using fallback');
                sections.push('\n---\n*Generated by ReadLater for Obsidian*');
            }

            return sections.join('\n\n');
            
        } catch (error) {
            const errorResult = this.errorHandler.handleError(
                new Error(`é›†ç´„Markdownç”Ÿæˆã«å¤±æ•—: ${error.message}`),
                { 
                    operation: 'generateAggregatedMarkdown', 
                    articlesCount: articles?.length || 0,
                    settingsValid: !!settings
                }
            );
            throw error;
        }
    }

    /**
     * æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«è¨˜äº‹ã‚’è¿½åŠ 
     * @param {string} existingContent - æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹
     * @param {Object} newArticle - æ–°è¦è¨˜äº‹
     * @param {Object} settings - ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
     * @returns {Promise<string>} æ›´æ–°ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„
     */
    async appendArticleContent(existingContent, newArticle, settings) {
        if (!existingContent || !this.isValidAggregatedFile(existingContent)) {
            // ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯æ–°è¦ä½œæˆ
            return await this.generateAggregatedMarkdown([newArticle], settings);
        }

        let updatedContent = existingContent;

        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ›´æ–°
        updatedContent = this.appendToArticleTable(updatedContent, newArticle, settings);

        // è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¨˜äº‹ã‚’è¿½åŠ 
        updatedContent = this.appendToDetailsSection(updatedContent, newArticle);

        // ç›®æ¬¡ã®æ›´æ–°
        updatedContent = this.updateTableOfContents(updatedContent);

        return updatedContent;
    }

    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã®ç”Ÿæˆï¼ˆãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼ä»˜ãï¼‰
     * @param {Object} settings - ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
     * @returns {string} ãƒ•ã‚¡ã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼
     */
    generateFileHeader(settings) {
        const title = settings.title || this.options.defaultTitle;
        const now = new Date().toISOString().split('T')[0];
        const timestamp = new Date().toISOString();
        
        // ãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼ç”Ÿæˆï¼ˆæ—¢å­˜ã®MarkdownGeneratorãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¸è¥²ï¼‰
        const frontmatter = `---
title: "${title}"
type: "aggregated-articles"
created: "${timestamp}"
updated: "${timestamp}"
tags: ["ReadLater", "aggregated", "articles"]
cssclass: "readlater-aggregated"
total_articles: 0
---`;

        return `${frontmatter}

# ${title}

> ğŸ“š ReadLater for Obsidianã§ä¿å­˜ã—ãŸè¨˜äº‹ã®é›†ç´„ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™  
> ğŸ—“ï¸ **ä½œæˆæ—¥**: ${now} | **æœ€çµ‚æ›´æ–°**: ${now}

`;
    }

    /**
     * ç›®æ¬¡ã®ç”Ÿæˆ
     * @param {Array<Object>} articles - è¨˜äº‹é…åˆ—
     * @returns {string} ç›®æ¬¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³
     */
    generateTableOfContents(articles) {
        if (!articles || articles.length === 0) {
            return `## ç›®æ¬¡

è¨˜äº‹ã¯ã¾ã ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`;
        }

        const tocItems = articles.map(article => {
            const anchor = this.createAnchorLink(article.title);
            return `- [${article.title}](#${anchor})`;
        });

        return `## ç›®æ¬¡

${tocItems.join('\n')}`;
    }

    /**
     * è¨˜äº‹ä¸€è¦§è¡¨ã®ç”Ÿæˆï¼ˆæ¨™æº–ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹é€ ï¼‰
     * @param {Array<Object>} articles - è¨˜äº‹é…åˆ—
     * @param {Object} settings - ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
     * @returns {string} è¨˜äº‹ä¸€è¦§è¡¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³
     */
    generateArticleTable(articles, settings) {
        const sectionHeader = `## ğŸ“‹ è¨˜äº‹ä¸€è¦§

> ä¿å­˜ã•ã‚ŒãŸè¨˜äº‹ã®æ¦‚è¦ä¸€è¦§ã§ã™ã€‚ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¸ãƒ£ãƒ³ãƒ—ã§ãã¾ã™ã€‚

`;
        
        const header = this.tableManager.generateTableHeader(settings.tableColumns);
        
        if (!articles || articles.length === 0) {
            return sectionHeader + header + '\n\n*ã¾ã è¨˜äº‹ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚*';
        }

        const rows = articles.map(article => 
            this.tableManager.formatTableRow(article, settings.tableColumns)
        );

        const summaryStats = `
### ğŸ“Š çµ±è¨ˆæƒ…å ±
- **ç·è¨˜äº‹æ•°**: ${articles.length}ä»¶
- **æœ€æ–°ä¿å­˜**: ${this.getLatestSaveDate(articles)}
- **è¨€èªåˆ†å¸ƒ**: ${this.getLanguageDistribution(articles)}

`;

        return sectionHeader + summaryStats + header + '\n' + rows.join('\n');
    }

    /**
     * è¨˜äº‹è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“ã®ç”Ÿæˆï¼ˆæ¨™æº–ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹é€ ï¼‰
     * @param {Array<Object>} articles - è¨˜äº‹é…åˆ—
     * @returns {string} è¨˜äº‹è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³
     */
    generateArticleDetailsSection(articles) {
        const sectionHeader = `## ğŸ“– è¨˜äº‹è©³ç´°

> å„è¨˜äº‹ã®å®Œå…¨ãªç¿»è¨³å†…å®¹ã¨è©³ç´°æƒ…å ±ã§ã™ã€‚

`;

        if (!articles || articles.length === 0) {
            return sectionHeader + '*ã¾ã è¨˜äº‹ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨˜äº‹ã‚’ä¿å­˜ã™ã‚‹ã¨ã€ã“ã“ã«è©³ç´°å†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚*';
        }

        const sections = articles.map(article => 
            this.generateArticleDetailSection(article)
        );

        return sectionHeader + sections.join('\n\n---\n\n');
    }

    /**
     * å€‹åˆ¥è¨˜äº‹ã®è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆï¼ˆMarkdownGeneratorã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¸è¥²ï¼‰
     * @param {Object} article - è¨˜äº‹ãƒ‡ãƒ¼ã‚¿
     * @returns {string} è¨˜äº‹è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³
     */
    generateArticleDetailSection(article) {
        const sections = [];
        
        // è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆã‚¢ãƒ³ã‚«ãƒ¼ãƒªãƒ³ã‚¯å¯¾å¿œï¼‰
        sections.push(`### ${article.title}`);
        
        // è¨˜äº‹ãƒ¡ã‚¿æƒ…å ±ï¼ˆMarkdownGeneratorã®generateArticleInfoãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
        const metadata = this.generateArticleMetadata(article);
        sections.push(metadata);
        
        // AIè¦ç´„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
        if (article.summary && !article.summarySkipped) {
            sections.push(`#### ğŸ“„ AIè¦ç´„\n\n${article.summary}`);
        }
        
        // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç¿»è¨³å„ªå…ˆï¼‰
        if (article.translatedContent && !article.translationSkipped) {
            sections.push(`#### ğŸ“– ç¿»è¨³æ¸ˆã¿è¨˜äº‹å†…å®¹\n\n${article.translatedContent}`);
            
            // ç¿»è¨³ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°æ³¨è¨˜
            if (article.translationError) {
                sections.push(`*âš ï¸ ç¿»è¨³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${article.translationError}*`);
            }
            
            // åŸæ–‡ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å½¢å¼ã€MarkdownGeneratorã¨åŒæ§˜ï¼‰
            if (article.content) {
                sections.push(`<details>\n<summary>ğŸ“„ åŸæ–‡ã‚’è¡¨ç¤º</summary>\n\n${article.content}\n\n</details>`);
            }
        } else {
            sections.push(`#### ğŸ“– è¨˜äº‹å†…å®¹\n\n${article.content || 'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚'}`);
            
            // ç¿»è¨³ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸç†ç”±ãŒã‚ã‚Œã°è¡¨ç¤º
            if (article.translationSkipped && article.translationError) {
                sections.push(`*â„¹ï¸ ç¿»è¨³ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ: ${article.translationError}*`);
            }
        }
        
        return sections.join('\n\n');
    }

    /**
     * ç›®æ¬¡ã‚’æ›´æ–°
     * @param {string} content - ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
     * @returns {string} æ›´æ–°ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„
     */
    updateTableOfContents(content) {
        // è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡º
        const titleMatches = content.match(/### (.+)/g);
        const articles = titleMatches ? titleMatches.map(match => ({
            title: match.replace('### ', '')
        })) : [];

        // æ–°ã—ã„ç›®æ¬¡ã‚’ç”Ÿæˆ
        const newToc = this.generateTableOfContents(articles);

        // æ—¢å­˜ã®ç›®æ¬¡ã‚’ç½®æ›
        const tocRegex = /## ç›®æ¬¡[\s\S]*?(?=\n## (?!ç›®æ¬¡)|$)/;
        if (tocRegex.test(content)) {
            return content.replace(tocRegex, newToc);
        } else {
            // ç›®æ¬¡ãŒãªã„å ´åˆã¯è¿½åŠ 
            const headerEndIndex = content.indexOf('\n\n') + 2;
            return content.slice(0, headerEndIndex) + newToc + '\n\n' + content.slice(headerEndIndex);
        }
    }

    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ãƒƒã‚¿ãƒ¼ã®ç”Ÿæˆï¼ˆMarkdownGeneratorã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¸è¥²ï¼‰
     * @param {number} articleCount - è¨˜äº‹æ•°
     * @returns {string} ãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ãƒƒã‚¿ãƒ¼
     */
    generateFileFooter(articleCount) {
        const timestamp = new Date().toLocaleString('ja-JP');
        const now = new Date().toISOString().split('T')[0];
        
        return `
---

## ğŸ“ˆ ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±

- **ğŸ“Š ç·è¨˜äº‹æ•°**: ${articleCount}ä»¶
- **ğŸ“… æœ€çµ‚æ›´æ–°**: ${now}
- **ğŸ•’ æ›´æ–°æ™‚åˆ»**: ${timestamp}
- **ğŸ“± ç”Ÿæˆå…ƒ**: ReadLater for Obsidian
- **ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼**: é›†ç´„å‹Markdownãƒ•ã‚¡ã‚¤ãƒ«

---

*ğŸ“± Generated by ReadLater for Obsidian*  
*ğŸ•’ ${timestamp}*  
*ğŸ¯ Mode: Aggregated Articles*`;
    }

    /**
     * ã‚¢ãƒ³ã‚«ãƒ¼ãƒªãƒ³ã‚¯ã®ä½œæˆ
     * @param {string} title - ã‚¿ã‚¤ãƒˆãƒ«
     * @returns {string} ã‚¢ãƒ³ã‚«ãƒ¼ãƒªãƒ³ã‚¯
     */
    createAnchorLink(title) {
        return title
            .toLowerCase()
            .replace(/[^a-z0-9\u3040-\u309f\u30a0-\u30ff\u4e00-\u9faf\s]/g, '-')
            .replace(/\s+/g, '-')
            .replace(/&/g, '-')
            .replace(/-+/g, '-')
            .replace(/^-|-$/g, '');
    }

    /**
     * è¨˜äº‹ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ–°è¦è¨˜äº‹ã‚’è¿½åŠ 
     * @param {string} content - ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
     * @param {Object} article - æ–°è¦è¨˜äº‹
     * @param {Object} settings - ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
     * @returns {string} æ›´æ–°ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„
     */
    appendToArticleTable(content, article, settings) {
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º
        const tableRegex = /(\| ã‚¿ã‚¤ãƒˆãƒ« \|[\s\S]*?)(?=\n## |$)/;
        const tableMatch = content.match(tableRegex);
        
        if (tableMatch) {
            const existingTable = tableMatch[1];
            const updatedTable = this.tableManager.addArticleToTable(article, existingTable);
            return content.replace(tableMatch[1], updatedTable);
        }
        
        return content;
    }

    /**
     * è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¨˜äº‹ã‚’è¿½åŠ 
     * @param {string} content - ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
     * @param {Object} article - æ–°è¦è¨˜äº‹
     * @returns {string} æ›´æ–°ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„
     */
    appendToDetailsSection(content, article) {
        const newDetail = this.generateArticleDetailSection(article);
        
        // è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æœ€å¾Œã«è¿½åŠ 
        const detailsRegex = /(## è¨˜äº‹è©³ç´°[\s\S]*?)(\n---)/;
        const detailsMatch = content.match(detailsRegex);
        
        if (detailsMatch) {
            const updatedDetails = detailsMatch[1] + '\n\n' + newDetail;
            return content.replace(detailsMatch[1], updatedDetails);
        } else {
            // è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ•ã‚¡ã‚¤ãƒ«æœ«å°¾ã«è¿½åŠ 
            return content + '\n\n' + newDetail;
        }
    }

    /**
     * æœ‰åŠ¹ãªé›†ç´„ãƒ•ã‚¡ã‚¤ãƒ«ã‹ãƒã‚§ãƒƒã‚¯
     * @param {string} content - ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
     * @returns {boolean} æœ‰åŠ¹ã‹ã©ã†ã‹
     */
    isValidAggregatedFile(content) {
        if (!content || typeof content !== 'string') {
            return false;
        }

        // å¿…è¦ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å­˜åœ¨ç¢ºèª
        const hasTitle = /^# /.test(content) || /\n# /.test(content); // ãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼å¯¾å¿œ
        const hasTable = /\| ã‚¿ã‚¤ãƒˆãƒ« \|/.test(content);
        const hasDetails = /## ğŸ“– è¨˜äº‹è©³ç´°/.test(content);

        return hasTitle && hasTable && hasDetails;
    }

    /**
     * è¨˜äº‹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æƒ…å ±ã®ç”Ÿæˆï¼ˆMarkdownGeneratorã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¸è¥²ï¼‰
     * @param {Object} article - è¨˜äº‹ãƒ‡ãƒ¼ã‚¿
     * @returns {string} ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æƒ…å ±
     */
    generateArticleMetadata(article) {
        const date = article.savedDate instanceof Date ? 
            article.savedDate.toISOString().split('T')[0] : 
            String(article.savedDate || '');
        
        let info = `**ğŸ“ å…ƒè¨˜äº‹**: [${article.title}](${article.url})\n`;
        info += `**ğŸŒ ãƒ‰ãƒ¡ã‚¤ãƒ³**: ${article.domain || new URL(article.url).hostname}\n`;
        info += `**ğŸ“… ä¿å­˜æ—¥**: ${date}\n`;
        
        if (article.author && article.author !== 'Unknown') {
            info += `**âœï¸ è‘—è€…**: ${article.author}\n`;
        }
        
        if (article.language && article.language !== 'unknown') {
            info += `**ğŸ—£ï¸ è¨€èª**: ${article.language}\n`;
        }
        
        if (article.detectedLanguage && article.detectedLanguage !== 'unknown') {
            info += `**ğŸ” æ¤œå‡ºè¨€èª**: ${article.detectedLanguage}\n`;
        }
        
        if (article.readingTime && article.readingTime !== 'Unknown') {
            info += `**â±ï¸ èª­äº†æ™‚é–“**: ç´„${article.readingTime}åˆ†\n`;
        }
        
        return info;
    }

    /**
     * æœ€æ–°ä¿å­˜æ—¥ã‚’å–å¾—
     * @param {Array<Object>} articles - è¨˜äº‹é…åˆ—
     * @returns {string} æœ€æ–°ä¿å­˜æ—¥
     */
    getLatestSaveDate(articles) {
        if (!articles || articles.length === 0) return 'æœªä¿å­˜';
        
        const dates = articles.map(article => {
            const date = article.savedDate instanceof Date ? 
                article.savedDate : 
                new Date(article.savedDate || 0);
            return date;
        });
        
        const latest = new Date(Math.max(...dates));
        return latest.toISOString().split('T')[0];
    }

    /**
     * è¨€èªåˆ†å¸ƒã‚’å–å¾—
     * @param {Array<Object>} articles - è¨˜äº‹é…åˆ—
     * @returns {string} è¨€èªåˆ†å¸ƒã®æ–‡å­—åˆ—
     */
    getLanguageDistribution(articles) {
        if (!articles || articles.length === 0) return 'ãªã—';
        
        const langCount = {};
        articles.forEach(article => {
            const lang = article.detectedLanguage || article.language || 'unknown';
            langCount[lang] = (langCount[lang] || 0) + 1;
        });
        
        const langEntries = Object.entries(langCount)
            .sort((a, b) => b[1] - a[1]) // ä»¶æ•°é †ã§ã‚½ãƒ¼ãƒˆ
            .slice(0, 3) // ä¸Šä½3ã¤
            .map(([lang, count]) => `${lang}(${count})`);
        
        return langEntries.join(', ');
    }

    /**
     * æ¨™æº–é›†ç´„ãƒ•ã‚¡ã‚¤ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹é€ ã‚’å–å¾—
     * @param {Object} settings - ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
     * @returns {string} ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹é€ ã®èª¬æ˜
     */
    getStandardTemplateStructure(settings) {
        const title = settings.title || this.options.defaultTitle;
        
        return `# é›†ç´„ãƒ•ã‚¡ã‚¤ãƒ«æ¨™æº–ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹é€ 

ä»¥ä¸‹ã¯${title}ã§ä½¿ç”¨ã•ã‚Œã‚‹æ¨™æº–çš„ãªMarkdownæ§‹é€ ã§ã™ï¼š

## 1. ãƒ•ã‚¡ã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼ + ã‚¿ã‚¤ãƒˆãƒ«ï¼‰
- YAMLå½¢å¼ã®Obsidianäº’æ›ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
- é›†ç´„ãƒ•ã‚¡ã‚¤ãƒ«è­˜åˆ¥ã‚¿ã‚°
- ä½œæˆãƒ»æ›´æ–°æ—¥æ™‚
- ç·è¨˜äº‹æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼

## 2. ç›®æ¬¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³
- ä¿å­˜ã•ã‚ŒãŸè¨˜äº‹ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
- è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®ã‚¢ãƒ³ã‚«ãƒ¼ãƒªãƒ³ã‚¯
- å‹•çš„æ›´æ–°ã«ã‚ˆã‚‹æœ€æ–°çŠ¶æ…‹ã®ç¶­æŒ

## 3. è¨˜äº‹ä¸€è¦§è¡¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³
- çµ±è¨ˆæƒ…å ±ï¼ˆè¨˜äº‹æ•°ã€æœ€æ–°ä¿å­˜æ—¥ã€è¨€èªåˆ†å¸ƒï¼‰
- Markdownè¡¨å½¢å¼ã®è¨˜äº‹ãƒªã‚¹ãƒˆ
- å„è¡Œï¼šã‚¿ã‚¤ãƒˆãƒ«ã€URLã€è¦ç´„ã€ä¿å­˜æ—¥ã€è¨€èª

## 4. è¨˜äº‹è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³
- å„è¨˜äº‹ã®å®Œå…¨ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„
- ç¿»è¨³æ¸ˆã¿å†…å®¹ï¼ˆåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
- AIç”Ÿæˆè¦ç´„
- åŸæ–‡ï¼ˆæŠ˜ã‚ŠãŸãŸã¿è¡¨ç¤ºï¼‰
- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æƒ…å ±

## 5. ãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ãƒƒã‚¿ãƒ¼
- ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ï¼ˆè¨˜äº‹æ•°ã€æ›´æ–°æ—¥æ™‚ï¼‰
- ReadLater for Obsidianã®ç½²å
- é›†ç´„ãƒ¢ãƒ¼ãƒ‰è­˜åˆ¥å­

ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹é€ ã«ã‚ˆã‚Šã€è¨˜äº‹ã®æ¦‚è¦æŠŠæ¡ã‹ã‚‰è©³ç´°é–²è¦§ã¾ã§
åŠ¹ç‡çš„ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿç¾ã•ã‚Œã¾ã™ã€‚`;
    }
}

// ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { AggregatedMarkdownGenerator };
} else {
    // ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã®åˆ©ç”¨
    const g = (typeof self !== 'undefined') ? self : 
              (typeof window !== 'undefined') ? window : globalThis;
    g.AggregatedMarkdownGenerator = AggregatedMarkdownGenerator;
}